<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .chat-message {
            max-width: 70%;
            word-wrap: break-word;
        }
        .table-container {
            max-width: 100%;
            overflow-x: auto;
        }
        .chat-table {
            width: 100%;
            min-width: 500px; /* Adjust this value as needed */
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">
    <!-- Top bar -->
    <div class="bg-white border-b border-gray-200 p-4 flex justify-between items-center">
        <h1 class="text-xl font-semibold text-gray-800">AI Chat Assistant</h1>
        <div class="flex space-x-4">
           
            <button id="Home" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300">
                Home
            </button>
        </div>
    </div>

    <!-- Main chat area -->
    <div class="flex-grow flex flex-col overflow-hidden">
        <!-- Chat messages -->
        <div id="chatHistory" class="flex-grow overflow-y-auto p-4 space-y-4"></div>

        <!-- Message input -->
        <div class="bg-white border-t border-gray-200 p-4">
            <form id="messageForm" class="flex items-center">
                <input type="text" id="messageInput" class="flex-grow px-4 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type a message...">
                <button type="submit" id="sendButton" class="bg-blue-500 text-white px-6 py-2 rounded-r-lg hover:bg-blue-600 transition duration-300">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- History modal -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-3/4 max-w-2xl">
            <h2 class="text-2xl font-bold mb-4">Chat History</h2>
            <div id="historyContent" class="max-h-96 overflow-y-auto"></div>
            <button id="closeHistory" class="mt-4 bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition duration-300">Close</button>
        </div>
    </div>

    <div id="errorMessage" class="fixed bottom-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg hidden"></div>

    <script>
        $(document).ready(function() {
            let threadId = new URLSearchParams(window.location.search).get('threadId') || localStorage.getItem('threadId');
            let assistantId = new URLSearchParams(window.location.search).get('assistantId') || localStorage.getItem('assistantId');

            document.getElementById("Home").addEventListener("click", function() {
                window.location.href = 'index.html';
            });

        
            if (!threadId || !assistantId) {
                getOrCreateThread();
            } else {
                loadChatHistory();
            }
        
            function getOrCreateThread() {
                $.ajax({
                    url: "/api/get-or-create-thread",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ user_id: 'default_user' }),
                    success: function(response) {
                        threadId = response.thread_id;
                        assistantId = response.assistant_id;
                        localStorage.setItem('threadId', threadId);
                        localStorage.setItem('assistantId', assistantId);
                        loadChatHistory();
                    },
                    error: function(xhr, status, error) {
                        console.error("Error getting or creating thread:", error);
                        showError("Failed to initialize chat. Please try again.");
                    }
                });
            }
        
            function loadChatHistory() {
                $.ajax({
                    url: "/api/list-messages",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ threadId: threadId }),
                    success: function(response) {
                        $("#chatHistory").empty();
                        response.messages.reverse().forEach(function(message) {
                            if (!message.content.startsWith("Financial data chunk:")) {
                                if (message.role === 'user') {
                                    appendMessage('user', message.content);
                                } else {
                                    try {
                                        const parsedContent = JSON.parse(message.content);
                                        parseAndDisplayAIResponse(parsedContent);
                                    } catch (e) {
                                        console.error("Error parsing message content:", e);
                                        appendMessage('ai', message.content);
                                    }
                                }
                            }
                        });
                        setTimeout(scrollToBottom, 100);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error loading chat history:", error);
                        showError("Failed to load chat history. Please refresh the page.");
                    }
                });
                }
        
            function handleExcelResponse(data, contentDisposition) {
                let filename = 'response.xlsx';
                if (contentDisposition) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(contentDisposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }

                const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                
                const downloadLink = `<a href="${url}" download="${filename}" class="text-blue-500 hover:text-blue-700 underline">Download Excel File</a>`;
                appendMessage('ai', `An Excel file has been generated. ${downloadLink}`);
            }

            function appendMessage(role, content) {
                const messageClass = role === 'user' ? 'bg-blue-100 ml-auto' : 'bg-gray-100';
                const alignClass = role === 'user' ? 'items-end' : 'items-start';
                $("#chatHistory").append(`
                    <div class="flex ${alignClass}">
                        <div class="rounded-lg p-3 chat-message ${messageClass}">
                            <p class="text-sm text-gray-600 mb-1">${role === 'user' ? 'You' : 'AI'}</p>
                            <div>${content}</div>
                        </div>
                    </div>
                `);
                setTimeout(scrollToBottom, 0);
            }
        
            function sendMessage(message) {
                appendMessage('user', message);
                $("#sendButton").prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i>');
                $.ajax({
                    url: "/api/get-response",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        threadId: threadId,
                        assistantId: assistantId,
                        question: message
                    }),
                    dataType: 'json',
                    success: function(response, status, xhr) {
                        console.log("Received response:", response);
                        if (response.response_type === "excel") {
                            getExcelFile(response.data);
                        } else {
                            parseAndDisplayAIResponse(response);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error sending message:", error);
                        console.log("XHR response:", xhr.responseText);
                        if (xhr.responseJSON && xhr.responseJSON.error === 'Thread has expired. Please create a new thread.') {
                            showError("Your session has expired. Starting a new chat...");
                            getOrCreateThread();
                        } else {
                            showError("Failed to send message. Please try again.");
                        }
                    },
                    complete: function() {
                        $("#sendButton").prop("disabled", false).html('<i class="fas fa-paper-plane"></i>');
                    }
                });
            }

            function getExcelFile(data) {
                $.ajax({
                    url: "/api/get-excel",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    xhrFields: {
                        responseType: 'arraybuffer'
                    },
                    success: function(response, status, xhr) {
                        handleExcelResponse(response, xhr.getResponseHeader("content-disposition"));
                    },
                    error: function(xhr, status, error) {
                        console.error("Error getting Excel file:", error);
                        showError("Failed to download Excel file. Please try again.");
                    }
                });
            }

            function parseAndDisplayAIResponse(response) {
                console.log("Parsing response:", response);
                try {
                    let parsedResponse = response;
                    if (typeof response === 'string') {
                        parsedResponse = JSON.parse(response);
                    }

                    if (parsedResponse.response_type === "string") {
                        appendMessage('ai', parsedResponse.data.comments);
                    } else if (parsedResponse.response_type === "table") {
                        appendTableResponse(parsedResponse.data);
                    } else if (parsedResponse.response_type === "excel") {
                        appendMessage('ai', "An Excel file was generated. (Excel files can't be displayed directly in chat history)");
                    } else {
                        console.warn("Unknown response type:", parsedResponse.response_type);
                        appendMessage('ai', JSON.stringify(parsedResponse)); // Fallback to displaying raw content
                    }
                } catch (error) {
                    console.error("Error parsing response:", error);
                    appendMessage('ai', "An error occurred while processing the response.");
                }
            }

            function appendTableResponse(data) {
                let tableHtml = '<div class="table-container"><table class="chat-table bg-white border border-gray-300">';
                tableHtml += '<thead><tr>';
                data.headers.forEach(header => {
                    tableHtml += `<th class="py-2 px-4 border-b">${header}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';
                data.rows.forEach(row => {
                    tableHtml += '<tr>';
                    row.forEach(cell => {
                        tableHtml += `<td class="py-2 px-4 border-b">${cell}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                tableHtml += '</tbody></table></div>';

                appendMessage('ai', tableHtml);
            }

            function scrollToBottom() {
                const chatHistory = document.getElementById('chatHistory');
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            function showError(message) {
                $("#errorMessage").text(message).removeClass("hidden");
                setTimeout(() => {
                    $("#errorMessage").addClass("hidden");
                }, 5000);
            }
        
            $("#messageForm").submit(function(e) {
                e.preventDefault();
                const message = $("#messageInput").val().trim();
                if (message) {
                    sendMessage(message);
                    $("#messageInput").val('');
                }
            });
        
            $("#clearChat").click(function() {
                if (confirm("Are you sure you want to clear the chat history?")) {
                    $("#chatHistory").empty();
                    // You may want to add an API call here to clear the chat history on the server side as well
                }
            });
        
            $("#newChat").click(function() {
                getOrCreateThread();
            });
        
            $("#viewHistory").click(function() {
                // Here you would typically fetch the chat history from the server
                // For now, we'll just show a placeholder message
                $("#historyContent").html("<p>Chat history will be displayed here.</p>");
                $("#historyModal").removeClass("hidden");
            });
        
            $("#closeHistory").click(function() {
                $("#historyModal").addClass("hidden");
            });

            // Scroll to bottom when the page loads and when the window is resized
            $(window).on('load resize', function() {
                setTimeout(scrollToBottom, 100);
            });

            // MutationObserver to detect changes in the chat history
            const chatHistoryObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        setTimeout(scrollToBottom, 0);
                    }
                });
            });

            chatHistoryObserver.observe(document.getElementById('chatHistory'), { childList: true, subtree: true });
        });
    </script>
</body>
</html>